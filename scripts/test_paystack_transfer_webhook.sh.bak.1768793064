#!/usr/bin/env bash
set -euo pipefail

DB_URL="${DATABASE_URL:-postgres://localhost:5432/rentease}"
PAYOUT_ID="${1:-}"

if [[ -z "$PAYOUT_ID" ]]; then
  echo "Usage: bash scripts/test_paystack_transfer_webhook.sh <payout_uuid>"
  exit 1
fi

# load env for PAYSTACK_SECRET_KEY
if [[ -f ".env" ]]; then
  set -a
  source .env
  set +a
fi

if [[ -z "${PAYSTACK_SECRET_KEY:-}" ]]; then
  echo "ERROR: PAYSTACK_SECRET_KEY not set. Put it in .env and rerun."
  exit 1
fi

# fetch payout row
row=$(psql "$DB_URL" -P pager=off -t -A -c "
select
  id::text,
  coalesce(nullif(gateway_payout_id::text,''), '') as gateway_payout_id,
  coalesce(amount::text,'0') as amount,
  coalesce(currency::text,'NGN') as currency
from public.payouts
where id = '$PAYOUT_ID'::uuid
limit 1;
")

if [[ -z "$row" ]]; then
  echo "ERROR: payout not found: $PAYOUT_ID"
  exit 1
fi

pid=$(printf '%s' "$row" | cut -d'|' -f1)
gpid=$(printf '%s' "$row" | cut -d'|' -f2)
amt=$(printf '%s' "$row" | cut -d'|' -f3)
cur=$(printf '%s' "$row" | cut -d'|' -f4)

ref="payout_${pid}"
transfer_code="$ref"
if [[ -n "$gpid" ]]; then
  transfer_code="$gpid"
fi

# NOTE: paystack event amount is often minor units; but your finalize handler likely uses DB payout amount.
# We'll send something consistent but it shouldn't break if ignored.
# If your DB amount is major (e.g. 2000.00), minor = 200000
minor=$(python3 - <<PY
from decimal import Decimal
amt=Decimal("$amt")
print(int(amt*100))
PY
)

BODY=$(cat <<JSON
{
  "event":"transfer.success",
  "data":{
    "reference":"payout_",
    "transfer_code":"$transfer_code",
    "amount":$minor,
    "currency":"$cur",
    "status":"success"
  }
}
JSON
)

SIG=$(printf '%s' "$BODY" \
  | openssl dgst -sha512 -mac HMAC -macopt "key:$PAYSTACK_SECRET_KEY" \
  | awk '{print $NF}')

echo "=== sending transfer.success ==="
echo "payout_id=$pid"
echo "reference=$ref"
echo "transfer_code=$transfer_code"
echo "amount_major=$amt currency=$cur amount_minor=$minor"
echo

curl -i -X POST "http://127.0.0.1:4000/webhooks/paystack" \
  -H "Content-Type: application/json" \
  -H "x-paystack-signature: $SIG" \
  --data "$BODY"

echo
echo "=== check payout after ==="
psql "$DB_URL" -P pager=off -c "
select
  id,
  status,
  gateway_payout_id,
  completed_at,
  updated_at
from public.payouts
where id = '$PAYOUT_ID'::uuid;
"
