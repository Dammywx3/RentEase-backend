#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT" || exit 1

DB_URL="${DB_URL:-postgres://localhost:5432/rentease}"

# Load .env so PAYSTACK_SECRET_KEY exists for signature
if [[ -f ".env" ]]; then
  set -a
  source .env
  set +a
fi

if [[ -z "${PAYSTACK_SECRET_KEY:-}" ]]; then
  echo "ERROR: PAYSTACK_SECRET_KEY not set. Ensure .env has it and re-run."
  exit 1
fi

echo "=== Picking ORG/USER/WALLET IDs ==="
ORG_ID="$(psql "$DB_URL" -P pager=off -Atc "select id::text from public.organizations order by created_at asc limit 1;")"
USER_ID="$(psql "$DB_URL" -P pager=off -Atc "select id::text from public.users order by created_at asc limit 1;")"
WALLET_ID="$(psql "$DB_URL" -P pager=off -Atc "select id::text from public.wallet_accounts order by created_at asc limit 1;")"

echo "ORG_ID=$ORG_ID"
echo "USER_ID=$USER_ID"
echo "WALLET_ID=$WALLET_ID"

if [[ -z "$ORG_ID" || -z "$USER_ID" || -z "$WALLET_ID" ]]; then
  echo "ERROR: missing required seed data (org/user/wallet_account)."
  exit 1
fi

echo
echo "=== payout_accounts columns ==="
cols="$(psql "$DB_URL" -P pager=off -Atc "
select column_name
from information_schema.columns
where table_schema='public' and table_name='payout_accounts'
order by ordinal_position;
")"
echo "$cols" | tr '\n' ' ' ; echo

has_col() { echo "$cols" | rg -qx "$1"; }

# Build insert column list + values list only for existing columns
COLUMNS=()
VALUES=()

# Always required (from your earlier inspection)
COLUMNS+=("organization_id"); VALUES+=("'$ORG_ID'::uuid")
COLUMNS+=("user_id");         VALUES+=("'$USER_ID'::uuid")
COLUMNS+=("provider");        VALUES+=("'paystack'")
COLUMNS+=("provider_token");  VALUES+=("'prov_tok_test_123'")

# Optional columns if they exist
if has_col "currency"; then
  COLUMNS+=("currency"); VALUES+=("'NGN'")
fi
if has_col "label"; then
  COLUMNS+=("label"); VALUES+=("'Test Payout Account'")
fi
if has_col "bank_name"; then
  COLUMNS+=("bank_name"); VALUES+=("'Test Bank'")
fi
if has_col "account_name"; then
  COLUMNS+=("account_name"); VALUES+=("'Test Account Name'")
fi
if has_col "account_number"; then
  COLUMNS+=("account_number"); VALUES+=("'0000000000'")
fi
if has_col "is_default"; then
  COLUMNS+=("is_default"); VALUES+=("true")
fi
# DO NOT assume is_active exists (your error proved it doesn't)

col_sql="$(IFS=,; echo "${COLUMNS[*]}")"
val_sql="$(IFS=,; echo "${VALUES[*]}")"

echo
echo "=== Create payout_account (schema-safe) ==="
PAYOUT_ACCT_ID="$((psql "$DB_URL" -P pager=off -Atc -q -t -A -X) "
insert into public.payout_accounts ($col_sql)
values ($val_sql)
returning id::text;
")"
echo "✅ PAYOUT_ACCT_ID=$PAYOUT_ACCT_ID"

echo
echo "=== Create payout ==="
PAYOUT_ID="$((psql "$DB_URL" -P pager=off -Atc -q -t -A -X) "
insert into public.payouts (organization_id, user_id, wallet_account_id, payout_account_id, amount, currency, status)
values ('$ORG_ID'::uuid, '$USER_ID'::uuid, '$WALLET_ID'::uuid, '$PAYOUT_ACCT_ID'::uuid, 1000.00, 'NGN', 'pending')
returning id::text;
")"
echo "✅ PAYOUT_ID=$PAYOUT_ID"

TRANSFER_CODE="trf_test_123"

echo
echo "=== Set payouts.gateway_payout_id ==="
psql "$DB_URL" -P pager=off -c "
update public.payouts
set gateway_payout_id='${TRANSFER_CODE}', updated_at=now()
where id='${PAYOUT_ID}'::uuid;
"

echo
echo "=== Send transfer.success webhook ==="
REF="payout_${PAYOUT_ID}"
BODY="{\"event\":\"transfer.success\",\"data\":{\"id\":\"trf_event_001\",\"transfer_code\":\"${TRANSFER_CODE}\",\"reference\":\"${REF}\",\"status\":\"success\"}}"

SIG="$(printf '%s' "$BODY" \
  | openssl dgst -sha512 -mac HMAC -macopt "key:${PAYSTACK_SECRET_KEY}" \
  | awk '{print $NF}')"

curl -s -i -X POST "http://127.0.0.1:4000/webhooks/paystack" \
  -H "Content-Type: application/json" \
  -H "x-paystack-signature: ${SIG}" \
  --data "$BODY" | sed -n '1,20p'

echo
echo "=== Payout after webhook ==="
psql "$DB_URL" -P pager=off -c "
select
  id,
  status,
  gateway_payout_id,
  processed_at,
  requested_at,
  updated_at
from public.payouts
where id = '${PAYOUT_ID}'::uuid;
"
