#!/usr/bin/env bash
set -euo pipefail

DB_URL="${DATABASE_URL:-postgres://localhost:5432/rentease}"

# Load .env so PAYSTACK_SECRET_KEY exists for signing
if [[ -f ".env" ]]; then
  set -a
  source .env
  set +a
fi

if [[ -z "${PAYSTACK_SECRET_KEY:-}" ]]; then
  echo "ERROR: PAYSTACK_SECRET_KEY not set. Put it in .env and rerun."
  exit 1
fi

psqlq() {
  # quiet, no rc, tuples-only, unaligned
  psql -X -q -t -A -P pager=off "$DB_URL" "$@"
}

echo "=== Picking ORG/USER/WALLET IDs ==="
ORG_ID="$(psqlq -c "select id::text from public.organizations limit 1;")"
USER_ID="$(psqlq -c "select id::text from public.users limit 1;")"
WALLET_ID="$(psqlq -c "select id::text from public.wallet_accounts limit 1;")"

if [[ -z "$ORG_ID" || -z "$USER_ID" || -z "$WALLET_ID" ]]; then
  echo "ERROR: need at least 1 org, 1 user, 1 wallet_account."
  echo "ORG_ID=$ORG_ID"
  echo "USER_ID=$USER_ID"
  echo "WALLET_ID=$WALLET_ID"
  exit 1
fi

echo "ORG_ID=$ORG_ID"
echo "USER_ID=$USER_ID"
echo "WALLET_ID=$WALLET_ID"
echo

echo "=== Inspect payout_accounts required columns ==="
req_cols="$(psqlq -c "
select column_name
from information_schema.columns
where table_schema='public'
  and table_name='payout_accounts'
  and is_nullable='NO'
  and (column_default is null or column_default = '')
  and column_name not in ('id','created_at','updated_at')
order by ordinal_position;
")"

echo "Required cols (no default):"
echo "$req_cols" | sed '/^$/d' | sed 's/^/ - /'
echo

suffix="$(date +%s)"
rcpt="test_rcpt_${suffix}"
token="test_provider_token_${suffix}"

cols=()
vals=()

while IFS= read -r c; do
  [[ -z "$c" ]] && continue
  case "$c" in
    organization_id) cols+=("$c"); vals+=("'$ORG_ID'::uuid") ;;
    user_id)         cols+=("$c"); vals+=("'$USER_ID'::uuid") ;;
    provider)        cols+=("$c"); vals+=("'paystack'") ;;
    currency)        cols+=("$c"); vals+=("'NGN'") ;;
    provider_token)  cols+=("$c"); vals+=("'$token'") ;;
    provider_recipient_code|recipient_code|paystack_recipient_code)
                   cols+=("$c"); vals+=("'$rcpt'") ;;
    account_name)    cols+=("$c"); vals+=("'Test Payout Account'") ;;
    bank_name)       cols+=("$c"); vals+=("'Test Bank'") ;;
    bank_code)       cols+=("$c"); vals+=("'000'") ;;
    account_number)  cols+=("$c"); vals+=("'0000000000'") ;;
    is_default)      cols+=("$c"); vals+=("true") ;;
    *)
      echo "ERROR: payout_accounts has a required column we don't know how to fill: $c"
      echo "Run: psql \"$DB_URL\" -P pager=off -c \"\\d public.payout_accounts\" and paste output here."
      exit 1
      ;;
  esac
done <<< "$req_cols"

COL_LIST="$(IFS=,; echo "${cols[*]}")"
VAL_LIST="$(IFS=,; echo "${vals[*]}")"

echo "=== Creating payout_account ==="
PAYOUT_ACCT_ID="$(psqlq -v ON_ERROR_STOP=1 -c "
begin;
select set_config('app.user_id', '$USER_ID', true);
select set_config('app.current_user', '$USER_ID', true);
select set_config('app.organization_id', '$ORG_ID', true);
select set_config('app.role', 'admin', true);

with ins as (
  insert into public.payout_accounts (${COL_LIST})
  values (${VAL_LIST})
  returning id::text as id
)
select id from ins;

commit;
" | tail -n 1 | tr -d '[:space:]')"

if [[ -z "$PAYOUT_ACCT_ID" ]]; then
  echo "ERROR: failed to create payout_account (no id returned)"
  exit 1
fi

echo "✅ PAYOUT_ACCT_ID=$PAYOUT_ACCT_ID"
echo

echo "=== Creating payout ==="
PAYOUT_ID="$(psqlq -v ON_ERROR_STOP=1 -c "
begin;
select set_config('app.user_id', '$USER_ID', true);
select set_config('app.current_user', '$USER_ID', true);
select set_config('app.organization_id', '$ORG_ID', true);
select set_config('app.role', 'admin', true);

with ins as (
  insert into public.payouts (
    organization_id, user_id, wallet_account_id, payout_account_id, amount, currency, status
  ) values (
    '$ORG_ID'::uuid,
    '$USER_ID'::uuid,
    '$WALLET_ID'::uuid,
    '$PAYOUT_ACCT_ID'::uuid,
    1000.00,
    'NGN',
    'pending'::payout_status
  )
  returning id::text as id
)
select id from ins;

commit;
" | tail -n 1 | tr -d '[:space:]')"

if [[ -z "$PAYOUT_ID" ]]; then
  echo "ERROR: failed to create payout (no id returned)"
  exit 1
fi

echo "✅ PAYOUT_ID=$PAYOUT_ID"
echo

REF="payout_${PAYOUT_ID}"
TRANSFER_CODE="$REF"

BODY=$(cat <<JSON
{"event":"transfer.success","data":{"reference":"$REF","transfer_code":"$TRANSFER_CODE","amount":100000,"currency":"NGN","status":"success"}}
JSON
)

SIG=$(printf '%s' "$BODY" \
  | openssl dgst -sha512 -mac HMAC -macopt "key:$PAYSTACK_SECRET_KEY" \
  | awk '{print $NF}')

echo "=== Sending transfer.success webhook ==="
curl -s -i -X POST "http://127.0.0.1:4000/webhooks/paystack" \
  -H "Content-Type: application/json" \
  -H "x-paystack-signature: $SIG" \
  --data "$BODY"
echo
echo

echo "=== Payout after webhook ==="
psql "$DB_URL" -P pager=off -c "
select
  id,
  status,
  gateway_payout_id,
  processed_at,
  requested_at,
  updated_at
from public.payouts
where id = '$PAYOUT_ID'::uuid;
"
