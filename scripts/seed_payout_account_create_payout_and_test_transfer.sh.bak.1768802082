#!/usr/bin/env bash
set -euo pipefail

DB_URL="${DB_URL:-postgres://localhost:5432/rentease}"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing: $1"; exit 1; }; }
need psql
need rg
need awk
need openssl
need curl

cd "$(dirname "$0")/.." || exit 1

# Load .env for PAYSTACK_SECRET_KEY (so webhook signing matches server)
if [[ -f .env ]]; then
  set -a
  source .env
  set +a
fi

echo "=== Picking ORG/USER/WALLET IDs ==="
ORG_ID="$(psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "select id::text from public.organizations order by created_at asc limit 1;")"
USER_ID="$(psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "select id::text from public.users order by created_at asc limit 1;")"
WALLET_ID="$(psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "select id::text from public.wallet_accounts order by created_at asc limit 1;")"

echo "ORG_ID=$ORG_ID"
echo "USER_ID=$USER_ID"
echo "WALLET_ID=$WALLET_ID"
echo

if [[ -z "$ORG_ID" || -z "$USER_ID" || -z "$WALLET_ID" ]]; then
  echo "ERROR: missing required seed data (org/user/wallet_account)."
  exit 1
fi

echo "=== payout_accounts columns ==="
psql "$DB_URL" -P pager=off -c "\d public.payout_accounts" >/dev/null 2>&1 || { echo "ERROR: payout_accounts table missing"; exit 1; }
COLS="$(psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "
select string_agg(column_name, ' ' order by ordinal_position)
from information_schema.columns
where table_schema='public' and table_name='payout_accounts';
")"
echo "$COLS"
echo

echo "=== Create payout_account (schema-safe) ==="
# Build insert dynamically based on existing columns (only include what exists)
col_sql=""
val_sql=""

addcol() {
  local col="$1"
  local val="$2"
  if echo " $COLS " | rg -q " $col "; then
    if [[ -n "$col_sql" ]]; then
      col_sql="${col_sql}, ${col}"
      val_sql="${val_sql}, ${val}"
    else
      col_sql="${col}"
      val_sql="${val}"
    fi
  fi
}

# Always include required cols (your schema showed these exist)
addcol "organization_id" "'${ORG_ID}'::uuid"
addcol "user_id" "'${USER_ID}'::uuid"
addcol "provider" "'paystack'::text"
addcol "provider_token" "'TEST_PROVIDER_TOKEN'::text"

# Optional nice-to-haves if present
addcol "currency" "'NGN'::text"
addcol "label" "'Test Payout Account'::text"
addcol "account_name" "'Test Account'::text"
addcol "bank_name" "'Test Bank'::text"
addcol "last4" "'0000'::text"
addcol "is_default" "true"

# Capture only the UUID (quiet tuples-only)
PAYOUT_ACCT_ID="$(psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "
insert into public.payout_accounts ($col_sql)
values ($val_sql)
returning id::text;
")"

echo "✅ PAYOUT_ACCT_ID=$PAYOUT_ACCT_ID"
echo

echo "=== Create payout ==="
PAYOUT_ID="$(psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "
insert into public.payouts (organization_id, user_id, wallet_account_id, payout_account_id, amount, currency, status)
values ('${ORG_ID}'::uuid, '${USER_ID}'::uuid, '${WALLET_ID}'::uuid, '${PAYOUT_ACCT_ID}'::uuid, 1000.00, 'NGN', 'pending')
returning id::text;
")"
echo "✅ PAYOUT_ID=$PAYOUT_ID"
echo

# Ensure webhook signing uses the same secret your server uses
if [[ -z "${PAYSTACK_SECRET_KEY:-}" ]]; then
  echo "ERROR: PAYSTACK_SECRET_KEY not set (load .env or export it)."
  exit 1
fi

# Seed gateway_payout_id so finalizePaystackTransferEvent can find payout by transfer_code
TRANSFER_CODE="trf_test_${PAYOUT_ID:0:8}"
psql "$DB_URL" -qAtX -v ON_ERROR_STOP=1 -c "
update public.payouts
set gateway_payout_id='${TRANSFER_CODE}', updated_at=now()
where id='${PAYOUT_ID}'::uuid;
" >/dev/null

echo "=== Sending transfer.success webhook ==="
REF="payout_${PAYOUT_ID}"
BODY="{\"event\":\"transfer.success\",\"data\":{\"id\":\"trf_test_123\",\"transfer_code\":\"${TRANSFER_CODE}\",\"reference\":\"${REF}\",\"amount\":100000,\"currency\":\"NGN\",\"status\":\"success\"}}"
SIG="$(printf '%s' "$BODY" | openssl dgst -sha512 -mac HMAC -macopt "key:$PAYSTACK_SECRET_KEY" | awk '{print $NF}')"

curl -i -X POST "http://127.0.0.1:4000/webhooks/paystack" \
  -H "Content-Type: application/json" \
  -H "x-paystack-signature: $SIG" \
  --data "$BODY"

echo
echo "=== Payout after webhook ==="
psql "$DB_URL" -P pager=off -c "
select
  id,
  status,
  gateway_payout_id,
  processed_at,
  requested_at,
  updated_at
from public.payouts
where id = '${PAYOUT_ID}'::uuid;
"
