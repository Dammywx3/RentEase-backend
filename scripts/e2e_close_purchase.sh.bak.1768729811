#!/usr/bin/env bash
set -euo pipefail

BASE_URL="${BASE_URL:-http://127.0.0.1:4000}"
DB="${DB:-rentease}"

EMAIL="${DEV_EMAIL:-${EMAIL:-}}"
PASSWORD="${DEV_PASS:-${PASSWORD:-}}"

PURCHASE_ID="${1:-}"
if [ -z "$PURCHASE_ID" ]; then
  echo "Usage: ./scripts/e2e_close_purchase.sh <PURCHASE_ID>"
  exit 1
fi

if [ -z "$EMAIL" ] || [ -z "$PASSWORD" ]; then
  echo "Set DEV_EMAIL + DEV_PASS (or EMAIL + PASSWORD)."
  exit 1
fi

echo "==> Login..."
LOGIN_JSON="$(curl -s -X POST "$BASE_URL/v1/auth/login" \
  -H "Content-Type: application/json" \
  --data-binary "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}")"

echo "$LOGIN_JSON"

OUT="/tmp/rentease_login_$$.txt"
printf "%s" "$LOGIN_JSON" | node - <<'NODE' > "$OUT"
let raw=""; process.stdin.setEncoding("utf8");
process.stdin.on("data",c=>raw+=c);
process.stdin.on("end",()=>{
  const j=JSON.parse(raw||"{}");
  if(j.ok===false){ console.error("LOGIN_FAILED"); process.exit(10); }
  process.stdout.write((j.token||"")+"\n"+(j.user?.organization_id||"")+"\n"+(j.user?.id||"")+"\n");
});
NODE

TOKEN="$(sed -n '1p' "$OUT" | tr -d '\r')"
ORG_ID="$(sed -n '2p' "$OUT" | tr -d '\r')"
rm -f "$OUT"

echo "==> Close purchase..."
curl -s -i -X POST "$BASE_URL/v1/purchases/$PURCHASE_ID/close" \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-organization-id: $ORG_ID" \
  -H "Content-Type: application/json" \
  --data-binary '{}' | sed -n '1,200p'

echo
echo "==> Verify purchase status..."
psql -X -P pager=off -d "$DB" -c "
select id::text, status::text, closed_at, updated_at
from public.property_purchases
where id::text='${PURCHASE_ID}'
limit 1;
" || true

echo
echo "==> Verify audit log..."
psql -X -P pager=off -d "$DB" -c "
select action, entity_type, entity_id::text, payload, created_at
from public.audit_logs
where entity_type='purchase' and entity_id::text='${PURCHASE_ID}'
order by created_at desc
limit 5;
" || true

echo "âœ… Done."
